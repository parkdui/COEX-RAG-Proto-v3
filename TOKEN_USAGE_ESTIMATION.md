# 6번 질문 시 예상 토큰 사용량 분석

## 현재 최적화 설정

### 1. Classification (질문 분류)
- **방식**: 키워드 기반 판별 (API 호출 없음)
- **토큰 사용량**: **0 tokens**

### 2. Embedding API
- **호출 조건**: 정보 요구 질문일 때만
- **질문 길이 제한**: 최대 50자
- **예상 토큰**: 50자 × 1.4 ≈ **70 tokens** (input만, output 없음)

### 3. Chat API (CLOVA Chat Completions)

#### System Prompt
- **기본 프롬프트**: system_prompt.txt (약 500자)
- **날짜 정보 추가**: 약 50자
- **총 System Prompt**: 약 550자 → **약 770 tokens**

#### User Message
- **질문 길이 제한**: 최대 30자 → 약 **42 tokens**
- **Context (정보 요구 질문일 때)**:
  - TOP_K: 1 (환경변수 기본값)
  - 제목: 최대 5자
  - 텍스트: 최대 10자
  - 구분자: "|"
  - 총 Context: 최대 15자 → 약 **21 tokens**
- **정보 요구 질문**: 42 + 21 = **63 tokens**
- **비정보 질문**: **42 tokens**

#### Output
- **maxTokens**: 80 tokens
- **예상 실제 출력**: 약 **60-80 tokens** (30자 이내 답변 제한)

#### History
- **히스토리**: 완전 제거 → **0 tokens**

### Chat API 토큰 요약
- **정보 요구 질문**: 770 (system) + 63 (user) + 70 (output) = **903 tokens**
- **비정보 질문**: 770 (system) + 42 (user) + 70 (output) = **882 tokens**

## 6번 질문 시나리오별 예상 토큰 사용량

### 시나리오 1: 정보 요구 질문 4개, 비정보 질문 2개 (일반적인 경우)

| 질문 번호 | Classification | Embedding | Chat API | 합계 |
|---------|----------------|-----------|----------|------|
| 1 (정보) | 0 | 70 | 903 | 973 |
| 2 (정보) | 0 | 70 | 903 | 973 |
| 3 (비정보) | 0 | 0 | 882 | 882 |
| 4 (정보) | 0 | 70 | 903 | 973 |
| 5 (정보) | 0 | 70 | 903 | 973 |
| 6 (비정보) | 0 | 0 | 882 | 882 |
| **총합** | **0** | **280** | **5,346** | **5,626 tokens** |

### 시나리오 2: 모든 질문이 정보 요구 질문 (최악의 경우)

| 질문 번호 | Classification | Embedding | Chat API | 합계 |
|---------|----------------|-----------|----------|------|
| 1 (정보) | 0 | 70 | 903 | 973 |
| 2 (정보) | 0 | 70 | 903 | 973 |
| 3 (정보) | 0 | 70 | 903 | 973 |
| 4 (정보) | 0 | 70 | 903 | 973 |
| 5 (정보) | 0 | 70 | 903 | 973 |
| 6 (정보) | 0 | 70 | 903 | 973 |
| **총합** | **0** | **420** | **5,418** | **5,838 tokens** |

### 시나리오 3: 모든 질문이 비정보 질문 (최선의 경우)

| 질문 번호 | Classification | Embedding | Chat API | 합계 |
|---------|----------------|-----------|----------|------|
| 1 (비정보) | 0 | 0 | 882 | 882 |
| 2 (비정보) | 0 | 0 | 882 | 882 |
| 3 (비정보) | 0 | 0 | 882 | 882 |
| 4 (비정보) | 0 | 0 | 882 | 882 |
| 5 (비정보) | 0 | 0 | 882 | 882 |
| 6 (비정보) | 0 | 0 | 882 | 882 |
| **총합** | **0** | **0** | **5,292** | **5,292 tokens** |

## 예상 토큰 사용량 범위

- **최소**: 약 **5,300 tokens** (모든 질문이 비정보 질문)
- **일반**: 약 **5,600 tokens** (정보 요구 질문 4개, 비정보 질문 2개)
- **최대**: 약 **5,800 tokens** (모든 질문이 정보 요구 질문)

## 주요 토큰 사용 지점

1. **System Prompt**: 약 770 tokens (매 질문마다 전송)
   - 이 부분이 가장 큰 토큰 사용 지점입니다.
   - 6번 질문 × 770 = 4,620 tokens

2. **Embedding API**: 정보 요구 질문당 70 tokens
   - 4개 질문 × 70 = 280 tokens

3. **Chat Output**: 질문당 약 70 tokens
   - 6번 질문 × 70 = 420 tokens

## 추가 최적화 가능 지점

1. **System Prompt 최적화**: 현재 약 770 tokens
   - 더 간결하게 작성하면 500-600 tokens로 줄일 수 있음
   - 6번 질문 기준 약 1,000-1,500 tokens 절감 가능

2. **질문 길이 제한**: 현재 30자
   - 더 줄이면 추가 절감 가능하나, 사용자 경험 저하 가능

3. **Context 압축**: 현재 최대 15자
   - 이미 극도로 압축된 상태

## 결론

**6번 질문 시 예상 토큰 사용량: 약 5,300 ~ 5,800 tokens**

현재 설정으로는 목표였던 2,000 tokens 이하를 달성하기 어려우며, System Prompt가 가장 큰 토큰 사용 지점입니다.

